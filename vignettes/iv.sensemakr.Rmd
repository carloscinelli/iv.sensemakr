---
title: "Sensitivity Analysis for Instrumental Variables using `iv.sensemakr`"
author: "Carlos Cinelli and Chad Hazlett"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Sensitivity Analysis for Instrumental Variables using iv.sensemakr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 5.5,
  fig.height = 4.5,
  fig.align = "center",
  dpi = 150
)
```

# Introduction

Instrumental variable (IV) methods are widely used in economics, epidemiology, and the social sciences to estimate causal effects when treatment assignment is confounded. A valid IV approach requires that, conditionally on observed covariates, the instrument is not confounded with the outcome, and that it influences the outcome only by affecting uptake of the treatment. The first assumption is usually called "exogeneity," "ignorability," or "unconfoundedness" of the instrument, whereas the second assumption is usually called the "exclusion restriction."

However, these assumptions are often violated in practice due to the presence of omitted confounders of the instrument; or, even when the instrument is randomized, by omitted side-effects of the instrument influencing the outcome via paths other than through the treatment. If these assumptions fail, the bias of the IV estimate may in fact be worse than the original confounding bias of the naive regression estimate. Therefore, researchers are often advised to perform sensitivity analyses to assess the degree of violation required to alter the conclusions of a study.

The package `iv.sensemakr` aims to help with this task, implementing a suite of sensitivity analysis tools for IV estimates as developed in [Cinelli and Hazlett (2025)](https://doi.org/10.1093/biomet/asaf004), which builds on the omitted variable bias (OVB) framework of [Cinelli and Hazlett (2020)](https://doi.org/10.1111/rssb.12348). The goal of `iv.sensemakr` is to make it easier to understand how violations of unconfoundedness or the exclusion restriction would affect the original findings of a study. 




# Estimating the returns to schooling

Given that sensitivity analysis requires contextual knowledge to be properly interpreted, we illustrate the basic functionality of the package with a real example. Here we reproduce the results found in Section 5 of Cinelli and Hazlett (2025). In a now famous paper, Card (1993) used proximity to college as an instrumental variable to estimate the casual effect of education on earnings. Here we revist that study, and quantify how robust the initial findings are to violations of unconfoundedness of the exclusion restriction.



## OLS findings and the OVB problem

Many observational studies have established a positive association between educational achievement and earnings using regression analysis. Here we consider the work of  Card (1993) who employed a sample of $n = 3{,}010$ individuals from the National Longitudinal Survey of Young Men. In a regression of log wages ($Y$) on years of education ($D$), adjusting for race, experience, and regional factors ($X$), Card found that each additional year of schooling was associated with approximately 7.5% higher wages. However, educational achievement is not randomly assigned. Individuals who obtain more education may have higher wages for other reasons, such as family background, or higher levels of some unobserved characteristic such as *Ability* or *Motivation*. Regression estimates that adjust for only a partial list of characteristics may thus suffer from omitted variable bias, likely overestimating the true returns to schooling.

## Original IV estimates

IV methods offer an alternative route to estimate the causal effect of schooling on earnings without having data on those unobserved variables. The key is to find a new variable (the *instrument*) that changes the incentives to educational achievement, but is associated with earnings only through its effect on education. Card proposed exploiting the role of geographic differences in college accessibility. The variable *Proximity* encodes whether the individual grew up near a four-year college ($Z$). Indeed, students who grow up far from college may face higher educational costs, discouraging them from pursuing higher level studies. More importantly, however, Card argues that whether one lives near a college is not itself confounded with earnings, nor does it cause earnings apart from its effect on years of education.


The `card` dataset is included in the package. The key variables are:

- `lwage`: log hourly wage in 1976 (outcome).
- `educ`: years of completed education (treatment).
- `nearc4`: indicator for proximity to a four-year college (instrument).

There are also various covariates, such as experience (`exper`), experience squared (`expersq`), race (`black`), whether the individual lived in a standard metropolitan area (`smsa`) and geographic region dummies. One can load the dataset with the folling command.

```{r load}
# load the package
library(iv.sensemakr)

# load the dataset
data("card")
```

Given the two assumptions articulated above, one can use *Proximity* as an IV for the effect of *Education* on *Earnings*. This estimate is given by the ratio of two OLS coefficients, one measuring the effect of *Proximity* on *Earnings* (the *reduced form*), and another measuring the effect of *Proximity* on *Education* (the *first stage*). One can obtain such estimates using the `iv.sensemakr` using the `iv_fit()` function. The function `iv_fit()` takes as input vectors for the outcome `y`, treatment `d`, instrument `z`, and an optional covariate matrix `x`. It computes IV estimates using the Anderson-Rubin (AR) approach, which is numerically equivalent to Two-Stage Least Squares (2SLS) for point estimation, but constructs confidence intervals via test inversion, a procedure that has correct coverage regardless of instrument strength.

```{r fit}
# prepare data
y <- card$lwage  # outcome: log wage
d <- card$educ   # treatment: years of education
z <- card$nearc4 # instrument: proximity to college
x <- model.matrix(~ exper + expersq + black + south + smsa + reg661 +
                     reg662 + reg663 + reg664 + reg665 + reg666 +
                     reg667 + reg668 + smsa66,
                   data = card)

# fit the IV model
card.fit <- iv_fit(y, d, z, x)
summary(card.fit)
```

The first-stage (FS) coefficient reveals that those who grew up near a college have completed an additional 0.32 years of education, on average. The reduced-form (RF) shows that proximity is associated with about 4.2% higher earnings. The IV estimate is then $\hat\tau \approx 0.042/0.319 \approx 0.132$, suggesting that each additional year of schooling raises wages by about 13.2%.

One can also use `coef()` and `confint()` to extract individual components of fitted object:

```{r coef}
# IV estimate and confidence interval
coef(card.fit)
confint(card.fit)

# first-stage and reduced-form estimates
coef(card.fit, parm = "fs")
coef(card.fit, parm = "rf")
```

## The IV estimate may suffer from omitted variable bias

The previous IV estimate relies on the assumption that, conditional on $X$, *Proximity* and *Earnings* are unconfounded, and the effect of *Proximity* on *Earnings* must go entirely through *Education*. As is often the case, neither assumption is easy to defend. The same factors that might confound the relationship between *Education* and *Earnings* could similarly confound the relationship between *Proximity* and *Earnings* (e.g., family wealth or connections). Moreover, the presence of a college nearby may be associated with high school quality, which in turn also affects earnings. Finally, geographic factors can make some localities likely to both have colleges nearby and lead to higher earnings---these are only coarsely conditioned on by the observed regional indicators, and residual biases may remain.

Therefore, instead of adjusting for $X$ only, we should have adjusted for *both* the observed covariates $X$ *and* unobserved covariates $W$, where $W$ stands for all unobserved factors necessary to make *Proximity* a valid instrument for the effect of *Education* on *Earnings*. How do the IV estimates from the model omitting $W$ compare with the estimates we actually want, from the model with $W$? 

## Sensitivity analysis

The main function of the package is  `sensemakr()`. This function takes an `iv_fit` object as input and performs the most commonly required sensitivity analyses, which can then be further explored. We begin the analysis by applying the function `sensemakr` to the `card.fit` object.

```{r sensemakr-full}
# with all parameters shown explicitly
card.sens <- sensemakr(model = card.fit,
                       benchmark_covariates = c("black", "smsa"),
                       kz = 1,               # benchmark multiplier for Z
                       ky = 1,               # benchmark multiplier for Y
                       q = 1,                # reduce estimate to zero
                       alpha = 0.05)         # significance level)
```


The arguments of the call are:
- `model`: the `iv_fit` object with the original IV  regression;
- `benchmark_covariates`: the names of observed covariates that will be used to bound the plausible strength of the omitted variables. Here we use `"black"` (an indicator of race) and `"smsa"` (an indicator of whether the individual lived in a standard metropolitan area).
- `kz`, `ky`:  these arguments parameterize how many times stronger the confounder is related to the instrument (kz) and to the outcome (ky)  in comparison to the observed benchmark covariates. 
- `q`:  this allows the user to specify what fraction of the effect estimate would have to be explained away to be problematic. Setting `q = 1`, as we do here, means that a reduction of 100% of the current effect estimate, that is, a true effect of zero, would be deemed problematic. The default is `1`.
- `alpha`: significance level of interest for making statistical inferences. The default is `0.05`

Using the default arguments, one can simplify the previous call to:

```{r sensemakr-simple}
card.sens <- sensemakr(card.fit, benchmark_covariates = c("black", "smsa"))
```


### Minimal sensitivity reporting
The print method of `sensemakr` provides a quick review of the original (unadjusted) estimate along with two summary sensitivity statistics suited for routine reporting. 

```{r}
card.sens
```

The **Robustness Value (RV)** describes the minimum partial $R^2$ that confounders or side-effects would need to have with *both* the instrument and the outcome in order to make the adjusted confidence interval include zero. In the Card example, the RV is about 0.67%, revealing that confounders or side-effects explaining 0.67% of the residual variation both of *Proximity* and of (log) *Earnings* are already sufficiently strong to make the IV estimate statistically insignificant. 

The **Extreme Robustness Value (XRV)** describes the minimum strength of association that omitted variables need to have with the *instrument alone* in order to be problematic. The XRV of 0.05% means that, if we are not willing to impose constraints on the partial $R^2$ of omitted variables with the outcome, than such omitted variables need only explain 0.05% of the residual variation of the instrument to be problematic.

These are useful quantities that summarize what we need to know in order to safely rule out confounders or side-effects of the instrument that are deemed to be problematic. Interpreting these values requires domain knowledge about the data generating process. Are the values of 0.67% or 0.05% enough to be confident on the original findings of this study? One way to assess the plausibility of omitted variables with such strength is to entertain the idea of confounders or side-effects as strong as observed covariates. That's given by the table named "Bounds on Omitted Variable Bias," which shows how strong omitted varialbes would be if they were as strong as `black` or `smsa`. As we can see, such variables would be sufficiently strong to overturn the results of the original study.

### Sensitivity contour plots

The previous sensitivity table provides a good summary of how robust the current estimate is to unobserved confounding. However, researchers may be willing to refine their analysis by visually exploring the whole range of possible estimates that omitted variables with different strengths could cause.  For these, one can use the plot method for sensemakr.

```{r plot-ci, fig.width = 10, fig.height = 5}
plot(card.sens, lim = 0.09)
```

The left plot shows bounds on the lower limit of the confidence interval whereas the right plot shows bounds on the upper limit of the confidence interval. In both cases, the horizontal axis shows the hypothetical strengh of confounders with the instrument. The vertical axis shows the hypothetical strengh of confounders with the untreated pontential outcome. The contour lines shows what the lower or upper limit of the confidence intervals would be, had we adjusted for omitted variables with such hypothetical strengths.

the critical threshold (zero), as well as the boundary beyond which confidence intervals become unbounded.
- **Labeled points**: benchmark bounds, showing where observed covariates fall on this plot.

The point labeled "observed" at the origin represents the original estimate, which assumes no violation of the IV assumptions. As we move away from the origin, (stronger omitted variables), the confidence interval widens.


# References

- Anderson, T.W. and Rubin, H. (1949), "Estimation of the parameters of a single equation in a complete system of stochastic equations," *Annals of Mathematical Statistics*, 20, 46--63.

- Card, D. (1995), "Using geographic variation in college proximity to estimate the return to schooling," in *Aspects of Labour Market Behaviour: Essays in Honour of John Vanderkamp*.

- Cinelli, C. and Hazlett, C. (2020), "Making Sense of Sensitivity: Extending Omitted Variable Bias," *Journal of the Royal Statistical Society, Series B (Statistical Methodology)*. [doi:10.1111/rssb.12348](https://doi.org/10.1111/rssb.12348).

- Cinelli, C. and Hazlett, C. (2025), "An Omitted Variable Bias Framework for Sensitivity Analysis of Instrumental Variables," *Biometrika*. [doi:10.1093/biomet/asaf004](https://doi.org/10.1093/biomet/asaf004).
